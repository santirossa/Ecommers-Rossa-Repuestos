 <div class="page-actions">
    <a href="/admin/products" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
    </div>

    <div class="panel">
        <div class="panel-header">
            <h2>${editMode ? 'Editar Producto' : 'Nuevo Producto'}</h2>
        </div>
        <div class="panel-body">
            <form id="productForm" onsubmit="handleProductSubmit(event)" enctype="multipart/form-data">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="name">Nombre del Producto *</label>
                        <input type="text" id="name" name="name" required
                            placeholder="Ej: Filtro de aceite IVECO Daily">
                    </div>

                    <div class="form-group full-width">
                        <label for="description">Descripción *</label>
                        <textarea id="description" name="description" rows="4" required
                            placeholder="Descripción detallada del producto..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="price">Precio (ARS) *</label>
                        <input type="number" id="price" name="price" step="0.01" min="0" required placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="stock">Stock *</label>
                        <input type="number" id="stock" name="stock" min="0" required placeholder="0">
                    </div>

                    <div class="form-group">
                        <label for="category">Categoría *</label>
                        <select id="category" name="category" required>
                            <option value="">Seleccionar categoría</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="brand">Marca</label>
                        <input type="text" id="brand" name="brand" value="IVECO" placeholder="IVECO">
                    </div>

                    <div class="form-group">
                        <label for="partNumber">Número de Parte</label>
                        <input type="text" id="partNumber" name="partNumber" placeholder="Ej: 2992544">
                    </div>

                    <div class="form-group">
                        <label for="compatibleModels">Modelos Compatibles</label>
                        <input type="text" id="compatibleModels" name="compatibleModels"
                            placeholder="Ej: Daily 35S14, Daily 70C17">
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="featured" name="featured">
                            <span>Producto Destacado</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="active" name="active" checked>
                            <span>Activo</span>
                        </label>
                    </div>

                    <div class="form-group full-width">
                        <label>Imágenes (máx. 5, hasta 5MB c/u)</label>
                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Arrastrá o hacé clic para subir imágenes</p>
                            <input type="file" id="images" name="images" multiple accept="image/*"
                                onchange="previewImages(this)">
                        </div>
                        <div class="image-preview" id="imagePreview"></div>
                        <div class="existing-images" id="existingImages"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save"></i> ${editMode ? 'Guardar Cambios' : 'Crear Producto'}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const isEditMode = ${ editMode };
        const productId = '${editMode ? productId : ''}';

        document.addEventListener('DOMContentLoaded', async () => {
            await loadCategories();
            if (isEditMode) await loadProduct();
        });

        async function loadCategories() {
            try {
                const data = await apiGet('/api/categories?all=true');
                if (data.success) {
                    const select = document.getElementById('category');
                    data.data.categories.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c._id;
                        opt.textContent = c.name;
                        select.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function loadProduct() {
            try {
                const data = await apiGet(`/api/products/${productId}`);
      if (data.success) {
        const p = data.data.product;
        document.getElementById('name').value = p.name;
        document.getElementById('description').value = p.description;
        document.getElementById('price').value = p.price;
        document.getElementById('stock').value = p.stock;
        document.getElementById('category').value = p.category?._id || '';
        document.getElementById('brand').value = p.brand;
        document.getElementById('partNumber').value = p.partNumber || '';
        document.getElementById('compatibleModels').value = p.compatibleModels || '';
        document.getElementById('featured').checked = p.featured;
        document.getElementById('active').checked = p.active;

        // Mostrar imágenes existentes
        if (p.images && p.images.length > 0) {
          const container = document.getElementById('existingImages');
          container.innerHTML = '<label>Imágenes actuales:</label><div class="image-grid">' +
            p.images.map(img => `
              <div class="image-item">
                <img src="${img}" alt="Producto">
                <button type="button" class="remove-img-btn" onclick="markRemoveImage(this, '${img}')">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `).join('') + '</div>';
        }
      }
    } catch (err) {
      showToast('Error al cargar producto', 'error');
    }
  }

  const removeImages = [];
  function markRemoveImage(btn, img) {
    removeImages.push(img);
    btn.closest('.image-item').style.opacity = '0.3';
    btn.disabled = true;
  }

  function previewImages(input) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    if (input.files) {
      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          preview.innerHTML += `<div class="image-item"><img src="${e.target.result}" alt="Preview"></div>`;
        };
        reader.readAsDataURL(file);
      });
    }
  }

  async function handleProductSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

    const formData = new FormData();
    formData.append('name', document.getElementById('name').value);
    formData.append('description', document.getElementById('description').value);
    formData.append('price', document.getElementById('price').value);
    formData.append('stock', document.getElementById('stock').value);
    formData.append('category', document.getElementById('category').value);
    formData.append('brand', document.getElementById('brand').value);
    formData.append('partNumber', document.getElementById('partNumber').value);
    formData.append('compatibleModels', document.getElementById('compatibleModels').value);
    formData.append('featured', document.getElementById('featured').checked);
    formData.append('active', document.getElementById('active').checked);

    // Nuevas imágenes
    const fileInput = document.getElementById('images');
    if (fileInput.files) {
      Array.from(fileInput.files).forEach(file => {
        formData.append('images', file);
      });
    }

    // Imágenes a eliminar
    removeImages.forEach(img => formData.append('removeImages', img));

    try {
      const url = isEditMode ? `/api/products/${productId}` : '/api/products';
      const method = isEditMode ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method,
        headers: { 'Authorization': 'Bearer ' + getToken() },
        body: formData,
      });

      const data = await response.json();

      if (data.success) {
        showToast(data.message, 'success');
        setTimeout(() => window.location.href = '/admin/products', 1000);
      } else {
        showToast(data.message || 'Error al guardar', 'error');
      }
    } catch (err) {
      showToast('Error de conexión', 'error');
    }

    btn.disabled = false;
    btn.innerHTML = isEditMode
      ? '<i class="fas fa-save"></i> Guardar Cambios'
      : '<i class="fas fa-save"></i> Crear Producto';
  }
    </script>
    